#!/usr/bin/env bash
set -euo pipefail

#==============================================================================
# tmux-agent-selector - FZF-based coding agent selector for tmux-sessionizer
#==============================================================================

# List of available coding agents
AGENTS=(
    "claude"
    "codex"
    "gemini"
    "opencode"
)

# Check if fzf is available
if ! command -v fzf &>/dev/null; then
    echo "Error: fzf is not installed" >&2
    exit 1
fi

# Check if tmux-sessionizer exists
if ! command -v tmux-sessionizer &>/dev/null; then
    echo "Error: tmux-sessionizer is not installed" >&2
    exit 1
fi

# Popup re-invocation: just run fzf and write selection to result file
if [[ -n "${_TAS_RESULT_FILE:-}" ]]; then
    printf '%s\n' "${AGENTS[@]}" | fzf \
        --prompt='Select Agent ❯ ' \
        --pointer='➤ ' \
        --marker='✓ ' \
        --reverse \
        --border \
        --color=marker:#98c379,fg+:#abb2bf,prompt:#61afef,hl+:#e06c75 \
        --header='Select a coding agent to launch' \
        >"$_TAS_RESULT_FILE" || true
    exit 0
fi

# Parent path: open popup that re-invokes this script in fzf-only mode
result_file=$(mktemp)

tmux display-popup -E -w 50% -h 50% \
    "bash -c '_TAS_RESULT_FILE=${result_file} ${0}'"

selected_agent=$(cat "$result_file")
rm -f "$result_file"

# Exit if nothing selected
[[ -z "$selected_agent" ]] && exit 0

# Launch the selected agent using tmux-sessionizer
exec tmux-sessionizer -c "$selected_agent"
