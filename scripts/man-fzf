#!/usr/bin/env bash
# man-fzf: Browse man pages with fzf + extras

# Get list of all man pages
list_man_pages() {
    man -k . 2>/dev/null | sort -u | awk -F' - ' '{print $1}'
}

# Choose a man page via fzf
selection=$(
    list_man_pages |
    FZF_DEFAULT_OPTS=${FZF_COMMON_OPTS} fzf --ansi \
        --preview 'page=$(echo {} | awk "{print \$1}"); man "$page" 2>/dev/null | col -bx | batcat -l man -p --color=always | head -n 40 ' \
        --bind "enter:accept" \
        --preview-window="right:60%" \
        --bind "ctrl-v:toggle-preview" \
        --header $'↵:open  ctrl-v:toggle preview' \
        --prompt="❯ " \
        --pointer="➤ " \
        --marker="✓ " \
        --color=marker:#98c379,fg+:#abb2bf,prompt:#61afef,hl+:#e06c75
)

# --preview-window=down,60%,wrap \

    # Exit if nothing was selected
[[ -z "$selection" ]] && exit 0

# Extract the man page name (first column before space)
page=$(echo "$selection" | awk '{print $1}')

# Extract section (in parentheses, e.g., printf (3))
section=$(echo "$selection" | awk '{print $2}' | tr -d '()')

man "$section" "$page" | col -bx | batcat -l man -p
