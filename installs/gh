#!/usr/bin/env bash
set -euo pipefail

# Ensure wget is installed
if ! command -v wget >/dev/null 2>&1; then
    echo "[INFO] Installing wget..."
    sudo apt update
    sudo apt install -y wget
fi

# Paths
GH_KEYRING="/etc/apt/keyrings/githubcli-archive-keyring.gpg"
GH_REPO="https://cli.github.com/packages"
GH_LIST="/etc/apt/sources.list.d/github-cli.list"

# Create keyrings dir
sudo mkdir -p -m 755 /etc/apt/keyrings

# Download key atomically
out=$(mktemp)
wget -nv -O "$out" "$GH_REPO/githubcli-archive-keyring.gpg"
sudo mv "$out" "$GH_KEYRING"
sudo chmod go+r "$GH_KEYRING"

# Create sources.list.d dir
sudo mkdir -p -m 755 /etc/apt/sources.list.d

# Add repo (overwrite if exists, idempotent)
echo "deb [arch=$(dpkg --print-architecture) signed-by=$GH_KEYRING] $GH_REPO stable main" |
sudo tee "$GH_LIST" >/dev/null

# Update and install GitHub CLI
sudo apt update
sudo apt install -y gh git

# Verify installation
echo "[INFO] GitHub CLI installed successfully!"
gh --version
