##############################################################################
#                           TMUX CONFIGURATION                              #
##############################################################################

#=============================================================================
# SECTION: BASIC SETTINGS
#=============================================================================
# Enable 24-bit color
set -g default-terminal "tmux-256color"

set-environment -g PATH "$HOME/.dotfiles/scripts:$HOME/.fzf/bin:$PATH"

# Update environment variables when attaching
set-option -g update-environment "DISPLAY XDG_SESSION_TYPE XAUTHORITY WAYLAND_DISPLAY"

set-hook -g client-attached 'run-shell tmux-sync-env'

set -g xterm-keys on

set-option -g status-position bottom

# Enable mouse support
set -g mouse on

# Start windows and panes at 1, not 0
set-option -g base-index 1
set-option -g pane-base-index 1

# Use vi key bindings in copy mode
setw -g mode-keys vi

# Change prefix from Ctrl-b to Ctrl-a
unbind C-b
set-option -g prefix C-a
bind C-a send-prefix

# Allow tmux to automatically rename windows to the running command
set-option -g automatic-rename on
set-option -g automatic-rename-format '#{b:pane_current_command}'



# --- Special rule: First window always "Editor" ---
# When a new session starts, rename window 1 explicitly
set-hook -g after-new-session 'rename-window -t 1 Editor'
# If you create a new first window (unlikely), enforce rename
set-hook -g after-new-window 'if "[ #{window_index} -eq 1 ]" "rename-window -t 1 Editor"'

#=============================================================================
# SECTION: KEY BINDINGS
#=============================================================================

# Copy mode bindings
bind-key -T copy-mode-vi y send -X copy-pipe-and-cancel "xclip -selection clipboard -i"
bind-key -T copy-mode-vi MouseDragEnd1Pane send-keys -X copy-pipe-and-cancel "xclip -selection clipboard -i"

# Pane splitting shortcuts
bind-key g split-window -h
bind-key v split-window -v

# Pane management
bind-key w command-prompt -p "Join pane from window:" "join-pane -s '%%'"
bind-key b break-pane


# Utility bindings
bind-key ? list-keys
bind-key ! command-prompt "run-shell '%%'"

bind-key . command-prompt -p "Swap/Move window index:" "run-shell 'tmux-swap-window %1'"

# --- Sessionizer shortcuts with Alt/Meta keys ---

# Ctrl-f → open tmux-sessionizer 
bind-key -T root C-f new-window "tmux-sessionizer"
# Prefix + Ctrl-f → send Ctrl-f keystroke to the shell
bind-key C-f send-keys C-f

# Alt-m → open tmux-sessionizer with slot 0(help-fzf) in a new window
bind-key -T root M-m new-window "tmux-sessionizer -s 0"
# Prefix + Alt-m → send Alt-m keystroke to the shell
bind-key M-m send-keys M-m

# Alt-b → open tmux-sessionizer with slot 1(btop) in a new window
bind-key -T root M-b  new-window "tmux-sessionizer -s 1"
# Prefix + Alt-b → send Alt-b keystroke to the shell
bind-key M-b send-keys M-b

# Alt-g → open tmux-sessionizer with slot 2(lazygit) in a new window
bind-key -T root M-g new-window "tmux-sessionizer -s 2"
# Prefix + Alt-g → send Alt-g keystroke to the shell
bind-key M-g send-keys M-g

# Alt-d → open tmux-sessionizer with slot 3(glow) in a new window
bind-key -T root M-d new-window "tmux-sessionizer -s 3"
# Prefix + Alt-d → send Alt-d keystroke to the shell
bind-key M-d send-keys M-d


# Bind Alt-l (Meta-l) to switch to the last session
bind-key -T root M-l switch-client -l
# Also allow Prefix + Alt-l to send keystroke to the shell
bind-key M-l send-keys M-l

# Bind Alt-w (Meta-w) to switch to the last window
bind-key -T root M-w last-window
# Also allow Prefix + Alt-w to send keystroke to the shell
bind-key M-w send-keys M-w

#=============================================================================
# SECTION: BUFFER MANAGEMENT
#=============================================================================
# Buffer shortcuts
bind-key S show-buffer \; display-message "Showing buffer_0 contents"  
# bind-key C capture-pane \; display-message "Captured pane to buffer"  
bind-key L list-buffers \; display-message "Listing all buffers"      
bind-key P choose-buffer \; display-message "Choose a buffer to paste"
bind-key W command-prompt -I "buf.txt" "Write-buffer '%%'" \; display-message "Buffer saved to file" 
bind-key D command-prompt -p "Buffer to delete:" "delete-buffer -b %%" \; display-message "Buffer deleted" 

#=============================================================================
# SECTION: PLUGIN MANAGEMENT
#=============================================================================
# List of plugins
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'christoomey/vim-tmux-navigator'
set -g @plugin 'dracula/tmux'
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'
# set -g @plugin 'omerxx/tmux-sessionx'

#=============================================================================
# SECTION: PLUGIN CONFIGURATION
#=============================================================================
# Resurrect configuration
resurrect_dir="$HOME/.tmux/resurrect"
set -g @resurrect-dir $resurrect_dir
set -g @resurrect-strategy-nvim 'session'
set -g @resurrect-strategy-vim 'session'
set -g @resurrect-save-interval 5
set -g @resurrect-capture-pane-contents 'on'
set -g @resurrect-save-on-exit 'on'
# Keep only the last 5 save files
set -g @resurrect-save-max 5

# Continuum configuration
set -g @continuum-boot 'on'
set -g @continuum-restore 'on'
set -g @continuum-save-interval '5'  # Save every 5 minutes
set -g @continuum-boot-options 'fullscreen'

# Dracula theme configuration

set -g @dracula-plugins "cpu-usage ram-usage battery time"
set -g @dracula-ram-usage-colors "cyan dark_gray"
set -g @dracula-battery-label "♥"
set -g @dracula-cpu-usage-label ""
set -g @dracula-ram-usage-label ""
set -g @dracula-show-powerline true
set -g @dracula-show-flags true
set -g @dracula-show-edge-icons true
set -g @dracula-show-left-icon "#S"
set -g @dracula-time-format "%d %b, %a %I:%M %p "
set -g @dracula-day-month true

set -g @dracula-colors "
# Dracula Color Pallette
white='#f8f8f2'
gray='#44475a'
dark_gray='#282a36'
light_purple='#bd93f9'
dark_purple='#6272aa'
cyan='#8be9fd'
green='#50fa7b'
orange='#ffb86c'
red='#ff5555'
pink='#ff79c6'
yellow='#f1fa8c'
"

# Advertise truecolor capability for tmux itself
set-option -as terminal-overrides ",tmux-256color:RGB"
set-option -as terminal-overrides ",xterm-256color:RGB"
set-option -as terminal-overrides ",alacritty:RGB"

# FZF options based on tmux version
# Default value in tmux < 3.2
TMUX_FZF_OPTIONS="-m"
# Default value in tmux >= 3.2
TMUX_FZF_OPTIONS="-p -w 70% -h 50% -m"


#=============================================================================
# SECTION: PLUGIN INITIALIZATION
#=============================================================================
# Initialize TMUX plugin manager (keep this line at the very bottom of tmux.conf)
run '~/.tmux/plugins/tpm/tpm'
